<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="破晓晨曦的个人笔记Blog，用于记录学习感悟及前沿技术。Xaviershi的博客。"><meta name="keywords" content="博客,个人博客,Xaviershi,XS个人博客,技术博客,XS,全栈工程师,破晓晨曦"><meta name="author" content="XS,破晓晨曦"><meta name="copyright" content="Xavier"><meta name="baidu-site-verification" content="eCDWBwIWCq"><title>eggjs搭建开发环境 | XS's Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.3"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e1c52888bff53137a720a05b1ab9eaa6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: {"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}"},"path":"search.xml"}
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Egg-创建、发布及部署-步骤"><span class="toc-number">1.</span> <span class="toc-text">Egg 创建、发布及部署 步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Egg-项目"><span class="toc-number">1.1.</span> <span class="toc-text">创建 Egg 项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署"><span class="toc-number">1.2.</span> <span class="toc-text">部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件的使用"><span class="toc-number">2.</span> <span class="toc-text">插件的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Egg-使用-Koa2-中间件"><span class="toc-number">2.1.</span> <span class="toc-text">Egg 使用 Koa2 中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用插件解决本地开发跨域问题-csrf"><span class="toc-number">2.2.</span> <span class="toc-text">使用插件解决本地开发跨域问题(csrf)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Sequelize-操作-MySQL-数据库"><span class="toc-number">2.3.</span> <span class="toc-text">使用 Sequelize 操作 MySQL 数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-egg-redis-连接-redis-数据库"><span class="toc-number">2.4.</span> <span class="toc-text">使用 egg-redis 连接 redis 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-常用命令"><span class="toc-number">2.4.1.</span> <span class="toc-text">redis 常用命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-egg-mongoose-连接-mongo-数据库"><span class="toc-number">2.5.</span> <span class="toc-text">使用 egg-mongoose 连接 mongo 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mongoose-使用技巧"><span class="toc-number">2.5.1.</span> <span class="toc-text">mongoose 使用技巧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#导入数据"><span class="toc-number">2.5.2.</span> <span class="toc-text">导入数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-egg-jwt-进行-Token-的分发"><span class="toc-number">2.6.</span> <span class="toc-text">使用 egg-jwt 进行 Token 的分发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-Tokne-的刷新和-sso-单点登录问题"><span class="toc-number">2.7.</span> <span class="toc-text">JWT Tokne 的刷新和 sso 单点登录问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参考资料"><span class="toc-number">2.7.1.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-UUID-包进行-uuid-的创建"><span class="toc-number">2.8.</span> <span class="toc-text">使用 UUID 包进行 uuid 的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-crypto-js-进行密码的加密"><span class="toc-number">2.9.</span> <span class="toc-text">使用 crypto-js 进行密码的加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-egg-validate-进行数据的校验"><span class="toc-number">2.10.</span> <span class="toc-text">使用 egg-validate 进行数据的校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-passport-来进行用户的-第三方-登录鉴权"><span class="toc-number">2.11.</span> <span class="toc-text">使用 passport 来进行用户的(第三方)登录鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参考资料-1"><span class="toc-number">2.11.1.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TSLint-设置"><span class="toc-number">3.</span> <span class="toc-text">TSLint 设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优质资源"><span class="toc-number">4.</span> <span class="toc-text">优质资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#《Node-js-实战-egg-vue-》"><span class="toc-number">4.1.</span> <span class="toc-text">《Node.js 实战(egg+vue)》</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-shell-decorators（蛋壳）"><span class="toc-number">4.2.</span> <span class="toc-text">egg-shell-decorators（蛋壳）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">4.3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/dalao.jpg"></div><div class="author-info__name text-center">Xavier</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">28</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">7</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top_img/2.jpg);"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">XS's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title-box"><div id="post-title">eggjs搭建开发环境</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-12-03</time><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2018/12/03/eggjs搭建开发环境/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2018/12/03/eggjs搭建开发环境/"></span></a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2,994</span><span class="post-meta__separator">|</span><span>阅读时长: 13 分钟</span></div></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><a id="more"></a>
<h2 id="Egg-创建、发布及部署-步骤"><a href="#Egg-创建、发布及部署-步骤" class="headerlink" title="Egg 创建、发布及部署 步骤"></a>Egg 创建、发布及部署 步骤</h2><h3 id="创建-Egg-项目"><a href="#创建-Egg-项目" class="headerlink" title="创建 Egg 项目"></a>创建 Egg 项目</h3><p><code>npm init egg</code><br>处理一下 TSLint 的报错问题：根目录<code>tslint.json</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"extends"</span>: [<span class="string">"tslint-config-egg"</span>],</span><br><span class="line">  <span class="string">"rules"</span>: &#123;</span><br><span class="line">    <span class="string">"quotemark"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>npm run dev</code> 启动 Egg 服务，运行在<code>http://127.0.0.1:7001/</code>地址</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>非 docker：<br><code>npm i egg-scripts --save</code> (本身自带)<br>添加 npm scripts 到 package.json：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"egg-scripts start --daemon"</span>,</span><br><span class="line">    <span class="attr">"stop"</span>: <span class="string">"egg-scripts stop"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个插件对 windows 支持有限，使用此插件可不使用 pm2</p>
<p><code>npm install --production</code><br><code>tar -zcvf ./release.tgz .</code><br>一般报错先查一下端口占用问题,<code>lsof -i:7001</code>,然后杀一下<code>kill -9 pid</code></p>
<h2 id="插件的使用"><a href="#插件的使用" class="headerlink" title="插件的使用"></a>插件的使用</h2><h3 id="Egg-使用-Koa2-中间件"><a href="#Egg-使用-Koa2-中间件" class="headerlink" title="Egg 使用 Koa2 中间件"></a>Egg 使用 Koa2 中间件</h3><ol>
<li><p>在 config 文件夹 <code>config.default.js</code>中设置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add your config here</span></span><br><span class="line">config.middleware = [<span class="string">"jwt"</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在 app/middleware 目录下面(没有则新建) 新建一个上面数组里的同名文件,比如 jwt.js ，然后写入中间件内容即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jwt.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"koa-jwt"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>☆ 不清楚这种插件是否也是像<code>this.app.**</code>这么使用，并且 config.js 里面配置的插件参数是否可用。</p>
<h3 id="使用插件解决本地开发跨域问题-csrf"><a href="#使用插件解决本地开发跨域问题-csrf" class="headerlink" title="使用插件解决本地开发跨域问题(csrf)"></a>使用插件解决本地开发跨域问题(csrf)</h3><ol>
<li><code>npm i egg-security egg-cors -S</code></li>
<li><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugin.js</span></span><br><span class="line">exports.security = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">"egg-security"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.cors = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">"egg-cors"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>运行时有黄色警告可能是<code>npm i</code>的时候自动将 security 插件一起装了，提示重复配置，注释了就行。</p>
</li>
<li><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.default.js</span></span><br><span class="line">config.security = &#123;</span><br><span class="line">  csrf: <span class="literal">false</span>,</span><br><span class="line">  ctoken: <span class="literal">false</span>,</span><br><span class="line">  domainWhiteList: [<span class="string">"http://127.0.0.1:7001"</span>, <span class="string">"http://192.168.1.101:7001"</span>]</span><br><span class="line">&#125;;</span><br><span class="line">config.cors = &#123;</span><br><span class="line">  origin: <span class="string">"*"</span>,</span><br><span class="line">  allowMethods: <span class="string">"GET,HEAD,PUT,POST,DELETE,PATCH"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="使用-Sequelize-操作-MySQL-数据库"><a href="#使用-Sequelize-操作-MySQL-数据库" class="headerlink" title="使用 Sequelize 操作 MySQL 数据库"></a>使用 Sequelize 操作 MySQL 数据库</h3><ol>
<li>添加 mysql 路径 <code>export PATH=${PATH}:/usr/local/mysql/bin</code></li>
<li><code>source ~/.bash_profile</code> 或者 <code>source ~/.zshrc</code></li>
<li><code>mysql -u root -p</code> 输入密码进入</li>
<li>创建一个数据库<code>create database demo;</code></li>
<li><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">"sequelize"</span>);</span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(<span class="string">"study01"</span>, <span class="string">"root"</span>, <span class="string">"965516531"</span>, &#123;</span><br><span class="line">  host: <span class="string">"localhost"</span>,</span><br><span class="line">  dialect: <span class="string">"mysql"</span>,</span><br><span class="line">  pool: &#123;</span><br><span class="line">    max: <span class="number">5</span>,</span><br><span class="line">    min: <span class="number">0</span>,</span><br><span class="line">    acquire: <span class="number">30000</span>,</span><br><span class="line">    idle: <span class="number">10000</span></span><br><span class="line">  &#125;,</span><br><span class="line">  operatorsAliases: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = sequelize.define(<span class="string">"user"</span>, &#123;</span><br><span class="line">  username: Sequelize.STRING,</span><br><span class="line">  birthday: Sequelize.DATE</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">  .sync()</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    User.create(&#123;</span><br><span class="line">      username: <span class="string">"demo"</span>,</span><br><span class="line">      birthday: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1980</span>, <span class="number">6</span>, <span class="number">20</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .then(<span class="function"><span class="params">jane</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(jane.toJSON());</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>使用此 js 文件测试数据库是否连接成功。如果使用 mysql8 版本创建数据库，选择使用宽松模式而不是强密码模式，因为大部分第三方库还未对强密码模式进行适配。</p>
</li>
</ol>
<h3 id="使用-egg-redis-连接-redis-数据库"><a href="#使用-egg-redis-连接-redis-数据库" class="headerlink" title="使用 egg-redis 连接 redis 数据库"></a>使用 egg-redis 连接 redis 数据库</h3><ol>
<li>安装 <code>brew install redis</code></li>
<li>启动 <code>brew services start redis</code></li>
<li>停止 <code>brew services stop redis</code></li>
<li>或者使用 redis 自带的启动停止<code>redis-server</code> <code>redis-server --port 6380</code> <code>redis-cli shutdown</code></li>
<li>用法是 <code>this.app.redis</code> 这样使用</li>
</ol>
<h4 id="redis-常用命令"><a href="#redis-常用命令" class="headerlink" title="redis 常用命令"></a>redis 常用命令</h4><ol>
<li>使用<code>redis-cli</code>进入 redis 客户端</li>
<li><code>keys *</code>获取所有的 key 值</li>
<li><code>get key</code>获取 key 对应的值</li>
<li><code>flushall</code>清除所有数据库的所有数据</li>
</ol>
<h3 id="使用-egg-mongoose-连接-mongo-数据库"><a href="#使用-egg-mongoose-连接-mongo-数据库" class="headerlink" title="使用 egg-mongoose 连接 mongo 数据库"></a>使用 egg-mongoose 连接 mongo 数据库</h3><p><code>npm i egg-mongoose --save</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugin.js</span></span><br><span class="line">exports.mongoose = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">"egg-mongoose"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/config.default.js</span></span><br><span class="line">exports.mongoose = &#123;</span><br><span class="line">  url: <span class="string">"mongodb://127.0.0.1/example"</span>,</span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// recommended</span></span><br><span class="line">exports.mongoose = &#123;</span><br><span class="line">  client: &#123;</span><br><span class="line">    url: <span class="string">"mongodb://127.0.0.1/example"</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/app/model/user.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> mongoose = app.mongoose;</span><br><span class="line">  <span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> UserSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">    userName: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">    password: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mongoose.model(<span class="string">"User"</span>, UserSchema);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;app_root&#125;/app/controller/user.js</span></span><br><span class="line"><span class="keyword">let</span> nuser = ctx.model.User.create(&#123;</span><br><span class="line">  userName: <span class="string">""</span>,</span><br><span class="line">  phoneNum: ctx.request.body.phoneNum,</span><br><span class="line">  password: ctx.request.body.password,</span><br><span class="line">  email: <span class="string">""</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>一开始建集合之后填入数据老是报一个错<code>E11000 duplicate key error collection</code>,解决方法之一是删了集合重新弄。</p>
<h4 id="mongoose-使用技巧"><a href="#mongoose-使用技巧" class="headerlink" title="mongoose 使用技巧"></a>mongoose 使用技巧</h4><ol>
<li><p>一个值多个字段进行查询</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> ctx.model.User.find(&#123;</span><br><span class="line">  $or: [</span><br><span class="line">    &#123; <span class="attr">phoneNum</span>: <span class="built_in">parseInt</span>(ctx.request.body.username) &#125;,</span><br><span class="line">    &#123; <span class="attr">userName</span>: ctx.request.body.username &#125;,</span><br><span class="line">    &#123; <span class="attr">email</span>: ctx.request.body.username &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询返回指定字段<br> find 方法第一个参数表示查询条件，第二个参数用于控制返回字段，第三个参数用于配置查询参数，第四个参数是回调。如果使用第三个参数而不用第二个参数，那么设置为 null。<br> 如果指定某些字段返回那么设置那个字段值为 1，如果指定某些字段不返回设置值为 0<br><code>let user: any = await ctx.model.User.find({ _id: ok.id }, { password: 0 })</code>,</p>
</li>
</ol>
<p><a href="https://segmentfault.com/a/1190000012095054#articleHeader11" target="_blank" rel="noopener">思否用法</a><br><a href="https://mongoosejs.com/docs/api.html#model_Model.findOne" target="_blank" rel="noopener">官方文档</a><br><a href="https://zhuanlan.zhihu.com/p/34374136" target="_blank" rel="noopener">知乎用法</a></p>
<h4 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h4><p>在数据文件目录使用命令导入数据表 <code>mongoimport -d meituan -c areas areas.dat</code> meituan 是数据库名字 areas 是集合(表名) areas.dat 是数据文件。</p>
<h3 id="使用-egg-jwt-进行-Token-的分发"><a href="#使用-egg-jwt-进行-Token-的分发" class="headerlink" title="使用 egg-jwt 进行 Token 的分发"></a>使用 egg-jwt 进行 Token 的分发</h3><ol>
<li><code>npm install egg-jwt --save</code></li>
<li><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line">exports.jwt = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">"egg-jwt"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/config.default.js</span></span><br><span class="line">exports.jwt = &#123;</span><br><span class="line">  secret: <span class="string">"123456"</span> <span class="comment">//自己设置的值</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分发 Token<code>const token = app.jwt.sign(userToken, secret, {expiresIn: &#39;1h&#39;})</code></p>
</li>
<li>校验 Tokne <code>const token = ctx.header.authorization</code></li>
<li>解密 Token <code>let payload = await app.jwt.verify(token.split(&#39; &#39;)[1], secret) // // 解密，获取payload</code></li>
</ol>
<p><a href="https://juejin.im/post/5bfc1bcdf265da61273d128a" target="_blank" rel="noopener">参考资料</a><br><a href="https://github.com/auth0/node-jsonwebtoken" target="_blank" rel="noopener">参数设置</a></p>
<h3 id="JWT-Tokne-的刷新和-sso-单点登录问题"><a href="#JWT-Tokne-的刷新和-sso-单点登录问题" class="headerlink" title="JWT Tokne 的刷新和 sso 单点登录问题"></a>JWT Tokne 的刷新和 sso 单点登录问题</h3><p>使用 Token 进行权限验证，为了防止重放攻击所以一般 token 设置一个过期时间。假如设置 1 小时过期时间，而用户在一小时内不停操作，但是 token 失效，这时候用户就被迫进行重新登录，这是不行的，所以需要 token 刷新。<br>假设一个设备登录 此 id 生成一个 token 正常：验证没问题 超时：redis 找这个 token 的数据 查里面的长 tokne 刷新时间 长 token 过期 app 登录 ❌<br>假设设备登录获取一个 token 时效 30d 未过期登录 查 redis 里面的 id 验证是不是一个 token 不是的话 说明这是老旧的未过期的 tokne  然后直接让让 app 重新登录 登录的时候服务端刷新 token 保证最新 这是 sso 单点登录<br> 但是假如这个 app 在 29 点最后时刻在使用 这时候 token 过期了 服务端返回 token 过期提示 然后 app 根据状态吗重新请求 token ❎<br>直接重新登录 但是这个 token 设置的可以很长<br>这个地方我也奇怪为什么有两个 tokne 的说法：<br><a href="https://segmentfault.com/q/1010000016407530" target="_blank" rel="noopener">JWT 为什么要设置 2 个 token?</a></p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="https://www.zhihu.com/question/53123279" target="_blank" rel="noopener">服务器设置了 cookie，浏览器却找不到？</a></p>
<h3 id="使用-UUID-包进行-uuid-的创建"><a href="#使用-UUID-包进行-uuid-的创建" class="headerlink" title="使用 UUID 包进行 uuid 的创建"></a>使用 UUID 包进行 uuid 的创建</h3><h3 id="使用-crypto-js-进行密码的加密"><a href="#使用-crypto-js-进行密码的加密" class="headerlink" title="使用 crypto-js 进行密码的加密"></a>使用 crypto-js 进行密码的加密</h3><p>使用<code>crypto-js</code>模块进行密码加密。</p>
<ol>
<li><code>npm i -save crypto-js</code></li>
<li><code>let CryptoJS = require(&#39;crypto-js&#39;)</code></li>
<li><code>CryptoJS.MD5(***).toString()</code></li>
</ol>
<p><a href="https://github.com/brix/crypto-js" target="_blank" rel="noopener">crypto-js</a></p>
<h3 id="使用-egg-validate-进行数据的校验"><a href="#使用-egg-validate-进行数据的校验" class="headerlink" title="使用 egg-validate 进行数据的校验"></a>使用 egg-validate 进行数据的校验</h3><ol>
<li><code>npm i egg-validate --save</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line">exports.validate = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">"egg-validate"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">exports.validate = &#123;</span><br><span class="line">  <span class="comment">// convert: false,</span></span><br><span class="line">  <span class="comment">// validateRoot: false,</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用方式:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rule = &#123;</span><br><span class="line">  phoneNum: <span class="string">"int"</span>,</span><br><span class="line">  email: &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"email"</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  userName: &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"string"</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  password: &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"password"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> error = <span class="keyword">this</span>.app.validator.validate(rule, ctx.request.body);</span><br></pre></td></tr></table></figure>
<p>若是 error 不为空，那么就是校验未通过，若是为空就是校验通过。<br>配置项及校验方式等写法参考 parameter:<br><a href="https://github.com/node-modules/parameter" target="_blank" rel="noopener">parameter</a></p>
<h3 id="使用-passport-来进行用户的-第三方-登录鉴权"><a href="#使用-passport-来进行用户的-第三方-登录鉴权" class="headerlink" title="使用 passport 来进行用户的(第三方)登录鉴权"></a>使用 passport 来进行用户的(第三方)登录鉴权</h3><p>不过这个插件的使用，好像是基于使用 egg 来渲染页面然后进行鉴权的方式，而 spa 大多使用 Token 的方式来进行验证。</p>
<h4 id="参考资料-1"><a href="#参考资料-1" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="http://www.scienjus.com/install-mysql-on-mac/" target="_blank" rel="noopener">在 Mac 下安装 MySQL</a><br><a href="https://www.jianshu.com/p/65595b0e59ad" target="_blank" rel="noopener">Mac 电脑安装及终端命令使用 mysql</a></p>
<h2 id="TSLint-设置"><a href="#TSLint-设置" class="headerlink" title="TSLint 设置"></a>TSLint 设置</h2><ol>
<li>引入一些没有 d.ts 文件的模块时提示不允许使用 require。解决办法:<code>&quot;no-var-requires&quot;: false,</code></li>
<li><p>必须使用单引号，jsx 中必须使用双引号，去掉 singel 就可以</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"quotemark"</span>: [</span><br><span class="line"><span class="literal">true</span>,</span><br><span class="line"><span class="string">"single"</span>,</span><br><span class="line"><span class="string">"jsx-double"</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p>对尾随逗号的校验</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"trailing-comma"</span>: [<span class="literal">true</span>, &#123; <span class="comment">//对尾随逗号的校验</span></span><br><span class="line"><span class="string">"multiline"</span>: &#123;</span><br><span class="line">    <span class="string">"objects"</span>: <span class="string">"ignore"</span>,</span><br><span class="line">    <span class="string">"arrays"</span>: <span class="string">"ignore"</span>,</span><br><span class="line">    <span class="string">"functions"</span>: <span class="string">"ignore"</span>,</span><br><span class="line">    <span class="string">"typeLiterals"</span>: <span class="string">"ignore"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"esSpecCompliant"</span>: <span class="literal">true</span> <span class="comment">//是否允许尾随逗号出现在剩余变量中</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>行尾是否以空格结尾(设置成 false 就不用必须加分号)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="string">"no-trailing-whitespace"</span>: [<span class="comment">// 不允许空格结尾</span></span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"ignore-comments"</span>,</span><br><span class="line">    <span class="string">"ignore-jsdoc"</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="优质资源"><a href="#优质资源" class="headerlink" title="优质资源"></a>优质资源</h2><h3 id="《Node-js-实战-egg-vue-》"><a href="#《Node-js-实战-egg-vue-》" class="headerlink" title="《Node.js 实战(egg+vue)》"></a>《Node.js 实战(egg+vue)》</h3><ol>
<li>书里还有发送邮件的方式 暂时不看</li>
</ol>
<h3 id="egg-shell-decorators（蛋壳）"><a href="#egg-shell-decorators（蛋壳）" class="headerlink" title="egg-shell-decorators（蛋壳）"></a>egg-shell-decorators（蛋壳）</h3><blockquote>
<p>Egg.js 路由装饰器，让你的开发更敏捷~</p>
</blockquote>
<p>自带路由解析和 Swagger。<br><a href="https://super2god.github.io/egg-shell-decorators/#/" target="_blank" rel="noopener">蛋壳</a></p>
<ol>
<li><code>npm install egg-shell-decorators -S</code></li>
<li><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">"egg"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EggShell &#125; <span class="keyword">from</span> <span class="string">"egg-shell-decorators"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app: Application) =&gt; &#123;</span><br><span class="line">  EggShell(app, &#123; prefix: <span class="string">"/"</span>, quickStart: <span class="literal">true</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>demo</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/user.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Controller &#125; <span class="keyword">from</span> <span class="string">"egg"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  Get,</span><br><span class="line">  IgnoreJwtAll,</span><br><span class="line">  Description,</span><br><span class="line">  TagsAll</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">"egg-shell-decorators"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TagsAll</span>(<span class="string">"用户"</span>)</span><br><span class="line"><span class="meta">@IgnoreJwtAll</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> SubOrderController <span class="keyword">extends</span> Controller &#123;</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">"/:id"</span>)</span><br><span class="line">  <span class="meta">@Description</span>(<span class="string">"根据id获取用户详情"</span>)</span><br><span class="line">  <span class="keyword">public</span> listUser(&#123; params: &#123; id &#125; &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      id</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 swagger-ui<br><a href="https://github.com/super2god/node-swagger-ui" target="_blank" rel="noopener">node-swagger-ui</a><br>作者提供的汉化版 swagger-ui 地址，并且附带使用 express 启动的 index.js 文件。<br>将整个项目 clone 下来，放到 app 目录下面 api-docs 文件夹里面并<code>npm i</code>。</p>
</li>
<li><p>router.js 改造</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">"egg"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EggShell &#125; <span class="keyword">from</span> <span class="string">"egg-shell-decorators"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app: Application) =&gt; &#123;</span><br><span class="line">  EggShell(app, &#123;</span><br><span class="line">    prefix: <span class="string">"/"</span>,</span><br><span class="line">    quickStart: <span class="literal">true</span>,</span><br><span class="line">    swaggerOpt: &#123;</span><br><span class="line">      open: <span class="literal">true</span>,</span><br><span class="line">      title: <span class="string">"示例"</span>,</span><br><span class="line">      version: <span class="string">"1.0.0"</span>,</span><br><span class="line">      host: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      port: <span class="number">7001</span>,</span><br><span class="line">      schemes: [<span class="string">"http"</span>],</span><br><span class="line">      paths: &#123;</span><br><span class="line">        outPath: <span class="string">"./api-docs/public/json/main.json"</span>,</span><br><span class="line">        definitionPath: <span class="string">"app/definitions"</span>,</span><br><span class="line">        swaggerPath: <span class="string">"app/swagger"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      tokenOpt: &#123;</span><br><span class="line">        <span class="keyword">default</span>: <span class="string">"manager"</span>,</span><br><span class="line">        tokens: &#123;</span><br><span class="line">          manager: <span class="string">"123"</span>,</span><br><span class="line">          user: <span class="string">"321"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ok 这样使用装饰器写的路由便会自动生成可以被 swagger 使用的 json 文档。</p>
</li>
<li><p>在 api-docs 目录里面使用 pm2 启动 index.js，<code>pm2 start index.js</code>，没装 pm2 的话 安装一下<code>npm i pm2 -g</code></p>
</li>
<li>localhost:3001 完工<br><img src="/images/eggjs-swagger-demo1.png" alt="demo"></li>
<li><p>如果你想尽量少些装饰器，使得 controller 看起来不那么臃肿，那么你也可以分开写。将模型写到<code>app/definitions</code>,</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// app/definitions/user.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"User"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"userName"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"姓名"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"phoneNum"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"integer"</span>,</span><br><span class="line">        <span class="attr">"format"</span>: <span class="string">"int32"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"手机号码"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"email"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"邮箱"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"password"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="attr">"description"</span>: <span class="string">"密码"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>swagger 的 req 和 res 框，写在<code>app/swagger</code>里面</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// app/swagger/user.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"/SignUp"</span>: &#123;</span><br><span class="line">    <span class="attr">"post"</span>: &#123;</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"用户注册"</span>,</span><br><span class="line">      <span class="attr">"parameters"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"name"</span>: <span class="string">"body"</span>,</span><br><span class="line">          <span class="attr">"in"</span>: <span class="string">"body"</span>,</span><br><span class="line">          <span class="attr">"required"</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">"schema"</span>: &#123;</span><br><span class="line">            <span class="attr">"$ref"</span>: <span class="string">"User"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"responses"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">        <span class="attr">"schema"</span>: &#123;</span><br><span class="line">          <span class="attr">"$ref"</span>: <span class="string">"User"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"/VerificationCode"</span>: &#123;</span><br><span class="line">    <span class="attr">"get"</span>: &#123;</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"发送验证码"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保持和 controller 文件夹里面的文件名一致，因为使用了路由映射。<br> controller/user.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller &#125; <span class="keyword">from</span> <span class="string">"egg"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Post, Get &#125; <span class="keyword">from</span> <span class="string">"egg-shell-decorators"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> UserController <span class="keyword">extends</span> Controller &#123;</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">"/VerificationCode"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> verificationCode() &#123;</span><br><span class="line">    <span class="keyword">let</span> code = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      phoneNum: <span class="keyword">this</span>.ctx.query.phoneNum || <span class="string">""</span>,</span><br><span class="line">      code,</span><br><span class="line">      msg: <span class="string">"验证码发送成功!"</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">"/SignUp"</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> singup() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> rule = &#123;</span><br><span class="line">      phoneNum: <span class="string">"int"</span>,</span><br><span class="line">      email: &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"email"</span>,</span><br><span class="line">        required: <span class="literal">false</span>,</span><br><span class="line">        <span class="keyword">default</span>: <span class="string">""</span></span><br><span class="line">      &#125;,</span><br><span class="line">      userName: &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"string"</span>,</span><br><span class="line">        required: <span class="literal">false</span>,</span><br><span class="line">        <span class="keyword">default</span>: <span class="string">""</span></span><br><span class="line">      &#125;,</span><br><span class="line">      password: &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"password"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> error = app.validator.validate(rule, ctx.request.body);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        code: <span class="number">-1</span>,</span><br><span class="line">        msg: error</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> user = <span class="keyword">await</span> ctx.model.User.find(&#123;</span><br><span class="line">        phoneNum: ctx.request.body.phoneNum</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (user.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          code: <span class="number">-1</span>,</span><br><span class="line">          msg: <span class="string">"账号已经注册!"</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> nuser = <span class="keyword">await</span> ctx.model.User.create(ctx.request.body);</span><br><span class="line">        <span class="keyword">if</span> (!nuser) &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            code: <span class="number">-1</span>,</span><br><span class="line">            msg: nuser</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            code: <span class="number">0</span>,</span><br><span class="line">            msg: <span class="string">"注册成功！"</span></span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>QuickStart 模式会自动帮助我们处理响应体，但这会导致多一层数据嵌套，可以选择在配置里将 QuickStart</p>
</li>
<li>如果使用 egg-jwt 做 token 校验，我们可以使用<code>IgnoreJwt</code>装饰器对当前路由进行忽略校验，使用<code>IgnoreJwtAll</code>可以对 controller 都进行忽略校验。</li>
<li>★★★ 有个问题注意下 蛋壳不是洋葱圈模型而是类似于注入，因此无法在中间件进行拦截，所以上面的 egg-jwt 校验也无法生效，需要手动用 egg 原生的中间件进行校验。 作者大大说找时间解决，waining…</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>做登录的时候有一个重要的问题，就是 token 的刷新问题。具体解决方法见上面 jwt 模块。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Xavier</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.xaviershi.com/2018/12/03/eggjs搭建开发环境/">http://blog.xaviershi.com/2018/12/03/eggjs搭建开发环境/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="http://blog.xaviershi.com" target="_blank">XS's Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><elif theme.sharejs && theme.sharejs.enable><div class="social-share" data-disabled="diandian"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></elif></article><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/12/06/RN勇者之路/"><i class="fa fa-chevron-left">  </i><span>RN勇者之路</span></a></div><div class="next-post pull-right"><a href="/2018/11/26/WEB小技巧/"><span>WEB小技巧</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://blog.xaviershi.com/2018/12/03/eggjs搭建开发环境/';
  this.page.identifier = '2018/12/03/eggjs搭建开发环境/';
  this.page.title = 'eggjs搭建开发环境';
}
var d = document, s = d.createElement('script');
s.src = "https://firstaurorablog.disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://firstaurorablog.disqus.com/count.js" async></script><elif theme.laibili && theme.laibili.enable></elif><elif theme.gitment && theme.gitment.enable></elif></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By Xavier</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.4.1"></script><script src="/js/fancybox.js?version=1.4.1"></script><script src="/js/sidebar.js?version=1.4.1"></script><script src="/js/copy.js?version=1.4.1"></script><script src="/js/fireworks.js?version=1.4.1"></script><script src="/js/transition.js?version=1.4.1"></script><script src="/js/scroll.js?version=1.4.1"></script><script src="/js/head.js?version=1.4.1"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":150,"height":250},"mobile":{"show":false},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body></html>